<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 20%; background-color: #2c3e50; color: white; padding: 20px; overflow-y: auto; }
        .main { width: 80%; display: flex; flex-direction: column; background-color: #ecf0f1; }
        .chat-window { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { background: white; padding: 10px; border-radius: 8px; max-width: 70%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .input-area { padding: 20px; background: white; border-top: 1px solid #ccc; display: flex; }
        input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { margin-left: 10px; padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; }
        h3 { border-bottom: 1px solid #34495e; padding-bottom: 10px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>Connected Users</h3>
        <ul id="user-list" style="list-style: none; padding: 0;"></ul>
    </div>
    <div class="main">
        <div class="chat-window" id="chat-window"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Type a message..." autofocus>
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const userList = document.getElementById('user-list');
        const msgInput = document.getElementById('msg-input');
        let lastMsgCount = 0;

        function sendMessage() {
            const msg = msgInput.value;
            if (!msg) return;
            
            fetch('/api/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: msg})
            }).then(() => {
                msgInput.value = '';
                fetchData(); // Refresh immediately
            });
        }

        msgInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });

        async function fetchData() {
            const response = await fetch('/api/data');
            const data = await response.json();

            // Update Users
            userList.innerHTML = data.users.map(u => `<li>ðŸŸ¢ ${u}</li>`).join('');

            // Update Messages only if new ones arrived
            if (data.messages.length > lastMsgCount) {
                const newMessages = data.messages.slice(lastMsgCount);
                newMessages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'message';
                    div.innerText = msg;
                    chatWindow.appendChild(div);
                });
                lastMsgCount = data.messages.length;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        // Poll every 1 second
        setInterval(fetchData, 1000);
        fetchData();
    </script>
</body>
</html>